<template>
  <div>
    <NavBar :key="componentKey" />
    <loading :active.sync="loading"></loading>
    <div>{{ api_key }} {{ api_key }}</div>
    <div class="container-fluid" style="margin-top: 25px">
      <h3 class="display-10" style="color: black">Current holdings</h3>
      <div class="row justify-content-center">
        <div class="col-sm-6" id="header">
          <b-table :items="assets" class="mt-2" outlined head-variant="dark">
          </b-table>
        </div>
        <div class="col-sm-6" id="header">
          <pieChart
            type="pie3d"
            width="600"
            height="600"
            dataFormat="json"
            :dataSource="pieChartData"
          >
          </pieChart>
        </div>
      </div>
    </div>
    <div class="container-fluid" style="margin-top: 25px">
      <h3 class="display-10" style="color: black">
        Historical Profit and Loss
      </h3>
      <div class="row justify-content-center">
        <div class="col-sm-7" id="header">
          <timeSeriesChart
            type="timeseries"
            width="100%"
            height="600"
            dataFormat="json"
            :dataSource="timeSeriesData"
          >
          </timeSeriesChart>
        </div>
        <div class="col-sm-5" id="header">
          <b-table :items="assets" class="mt-2" outlined head-variant="dark">
          </b-table>
        </div>
      </div>
    </div>
  </div>
</template>

<script>
import NavBar from "./NavBar";
import Loading from "vue-loading-overlay";
import "vue-loading-overlay/dist/vue-loading.css";
import { BTable } from "bootstrap-vue";
import Vue from "vue";
import VueFusionChartsComponent from "vue-fusioncharts/component";
import axios from "axios";
import { HOSTNAME } from "../config.js";

// import FusionCharts modules and resolve dependency
import FusionCharts from "fusioncharts";
import Charts from "fusioncharts/fusioncharts.charts";
import FusionTheme from "fusioncharts/themes/fusioncharts.theme.fusion";
import TimeSeries from "fusioncharts/fusioncharts.timeseries";

const pieChart = VueFusionChartsComponent(FusionCharts, Charts, FusionTheme);

const timeSeriesChart = VueFusionChartsComponent(
  FusionCharts,
  Charts,
  FusionTheme,
  TimeSeries
);

Vue.component("pieChart", pieChart);
Vue.component("timeSeriesChart", timeSeriesChart);

export default {
  name: "Portfolio",
  data() {
    return {
      loading: false,
      api_key: "",
      api_secret: "",
      assets: {},
      computed_assets: {},
      order_history: [
        {
          clientOrderId: "electron_9ffec4177f734afa9f566929aa9",
          cummulativeQuoteQty: "684.47903282",
          executedQty: "0.01245100",
          icebergQty: "0.00000000",
          isWorking: true,
          orderId: 5367415573,
          orderListId: -1,
          origQty: "0.01245100",
          origQuoteOrderQty: "0.00000000",
          price: "54975.00000000",
          side: "BUY",
          status: "FILLED",
          stopPrice: "0.00000000",
          symbol: "BTCUSDT",
          time: 1616828434753,
          timeInForce: "GTC",
          type: "LIMIT",
          updateTime: 1616828434753,
        },
        {
          clientOrderId: "electron_912506dd427c40df9e3d3604bfa",
          cummulativeQuoteQty: "124.95000000",
          executedQty: "0.07000000",
          icebergQty: "0.00000000",
          isWorking: true,
          orderId: 3366031412,
          orderListId: -1,
          origQty: "0.07000000",
          origQuoteOrderQty: "0.00000000",
          price: "1785.00000000",
          side: "BUY",
          status: "FILLED",
          stopPrice: "0.00000000",
          symbol: "ETHUSDT",
          time: 1615905150741,
          timeInForce: "GTC",
          type: "LIMIT",
          updateTime: 1615905173457,
        },
        {
          clientOrderId: "electron_fb588828fbd34be7961a0280618",
          cummulativeQuoteQty: "377.99178000",
          executedQty: "0.22261000",
          icebergQty: "0.00000000",
          isWorking: true,
          orderId: 3451001809,
          orderListId: -1,
          origQty: "0.22261000",
          origQuoteOrderQty: "0.00000000",
          price: "1698.00000000",
          side: "BUY",
          status: "FILLED",
          stopPrice: "0.00000000",
          symbol: "ETHUSDT",
          time: 1616828537904,
          timeInForce: "GTC",
          type: "LIMIT",
          updateTime: 1616829038452,
        },
        {
          clientOrderId: "electron_3d73a58d34624d5da3b6b723d85",
          cummulativeQuoteQty: "0.00000000",
          executedQty: "0.00000000",
          icebergQty: "0.00000000",
          isWorking: true,
          orderId: 3497459583,
          orderListId: -1,
          origQty: "0.04694000",
          origQuoteOrderQty: "0.00000000",
          price: "1885.00000000",
          side: "BUY",
          status: "CANCELED",
          stopPrice: "0.00000000",
          symbol: "ETHUSDT",
          time: 1617363677973,
          timeInForce: "GTC",
          type: "LIMIT",
          updateTime: 1617363771458,
        },
        {
          clientOrderId: "electron_c41f0cc1a53c4166b7aef90388e",
          cummulativeQuoteQty: "208.59972000",
          executedQty: "0.08652000",
          icebergQty: "0.00000000",
          isWorking: true,
          orderId: 3636985738,
          orderListId: -1,
          origQty: "0.08652000",
          origQuoteOrderQty: "0.00000000",
          price: "2411.00000000",
          side: "SELL",
          status: "FILLED",
          stopPrice: "0.00000000",
          symbol: "ETHUSDT",
          time: 1618664016034,
          timeInForce: "GTC",
          type: "LIMIT",
          updateTime: 1618664016232,
        },
        {
          clientOrderId: "electron_9203655292af40cebbd72ae2aae",
          cummulativeQuoteQty: "0.00000000",
          executedQty: "0.00000000",
          icebergQty: "0.00000000",
          isWorking: true,
          orderId: 1806132907,
          orderListId: -1,
          origQty: "0.55000000",
          origQuoteOrderQty: "0.00000000",
          price: "301.00000000",
          side: "BUY",
          status: "CANCELED",
          stopPrice: "0.00000000",
          symbol: "BNBUSDT",
          time: 1617363858830,
          timeInForce: "GTC",
          type: "LIMIT",
          updateTime: 1617379651198,
        },
        {
          clientOrderId: "electron_dd42fedb44cb43e69b7f962841f",
          cummulativeQuoteQty: "265.49365640",
          executedQty: "0.77200000",
          icebergQty: "0.00000000",
          isWorking: true,
          orderId: 1807480316,
          orderListId: -1,
          origQty: "0.77200000",
          origQuoteOrderQty: "0.00000000",
          price: "343.95000000",
          side: "BUY",
          status: "FILLED",
          stopPrice: "0.00000000",
          symbol: "BNBUSDT",
          time: 1617380855802,
          timeInForce: "GTC",
          type: "LIMIT",
          updateTime: 1617380855802,
        },
        {
          clientOrderId: "electron_62638b5e65c345aeac9e2a7ca83",
          cummulativeQuoteQty: "168.78061900",
          executedQty: "1000.30000000",
          icebergQty: "0.00000000",
          isWorking: true,
          orderId: 255177876,
          orderListId: -1,
          origQty: "1367.40000000",
          origQuoteOrderQty: "0.00000000",
          price: "0.16873000",
          side: "BUY",
          status: "CANCELED",
          stopPrice: "0.00000000",
          symbol: "ZILUSDT",
          time: 1616828501709,
          timeInForce: "GTC",
          type: "LIMIT",
          updateTime: 1616829423577,
        },
        {
          clientOrderId: "electron_bbabbff24aec423c9a4d12299e5",
          cummulativeQuoteQty: "0.00000000",
          executedQty: "0.00000000",
          icebergQty: "0.00000000",
          isWorking: true,
          orderId: 255216992,
          orderListId: -1,
          origQty: "373.10000000",
          origQuoteOrderQty: "0.00000000",
          price: "0.16710000",
          side: "BUY",
          status: "CANCELED",
          stopPrice: "0.00000000",
          symbol: "ZILUSDT",
          time: 1616831408973,
          timeInForce: "GTC",
          type: "LIMIT",
          updateTime: 1616832459059,
        },
        {
          clientOrderId: "electron_56b0e56f09984fa1820fd6c1e2b",
          cummulativeQuoteQty: "62.34480000",
          executedQty: "371.10000000",
          icebergQty: "0.00000000",
          isWorking: true,
          orderId: 255233022,
          orderListId: -1,
          origQty: "371.10000000",
          origQuoteOrderQty: "0.00000000",
          price: "0.16800000",
          side: "BUY",
          status: "FILLED",
          stopPrice: "0.00000000",
          symbol: "ZILUSDT",
          time: 1616832481185,
          timeInForce: "GTC",
          type: "LIMIT",
          updateTime: 1616832553626,
        },
        {
          clientOrderId: "electron_eb57be1322804ac182e338ac2d4",
          cummulativeQuoteQty: "0.00000000",
          executedQty: "0.00000000",
          icebergQty: "0.00000000",
          isWorking: true,
          orderId: 262447111,
          orderListId: -1,
          origQty: "232.40000000",
          origQuoteOrderQty: "0.00000000",
          price: "0.17280000",
          side: "BUY",
          status: "CANCELED",
          stopPrice: "0.00000000",
          symbol: "ZILUSDT",
          time: 1617363725641,
          timeInForce: "GTC",
          type: "LIMIT",
          updateTime: 1617363770547,
        },
        {
          clientOrderId: "electron_5567aa0073be425f907d08da343",
          cummulativeQuoteQty: "730.02484800",
          executedQty: "38.72400000",
          icebergQty: "0.00000000",
          isWorking: true,
          orderId: 364019916,
          orderListId: -1,
          origQty: "38.72400000",
          origQuoteOrderQty: "0.00000000",
          price: "19.15700000",
          side: "BUY",
          status: "FILLED",
          stopPrice: "0.00000000",
          symbol: "ATOMUSDT",
          time: 1615726485225,
          timeInForce: "GTC",
          type: "LIMIT",
          updateTime: 1615726485225,
        },
        {
          clientOrderId: "electron_8c0a0678784c44878d7c6115ff5",
          cummulativeQuoteQty: "0.00000000",
          executedQty: "0.00000000",
          icebergQty: "0.00000000",
          isWorking: true,
          orderId: 387212174,
          orderListId: -1,
          origQty: "38.68500000",
          origQuoteOrderQty: "0.00000000",
          price: "19.20000000",
          side: "SELL",
          status: "CANCELED",
          stopPrice: "0.00000000",
          symbol: "ATOMUSDT",
          time: 1616827148868,
          timeInForce: "GTC",
          type: "LIMIT",
          updateTime: 1616828127659,
        },
        {
          clientOrderId: "electron_0220b16eecd54ffcac87b5c308c",
          cummulativeQuoteQty: "738.88350000",
          executedQty: "38.68500000",
          icebergQty: "0.00000000",
          isWorking: true,
          orderId: 387231048,
          orderListId: -1,
          origQty: "38.68500000",
          origQuoteOrderQty: "0.00000000",
          price: "19.10000000",
          side: "SELL",
          status: "FILLED",
          stopPrice: "0.00000000",
          symbol: "ATOMUSDT",
          time: 1616828151694,
          timeInForce: "GTC",
          type: "LIMIT",
          updateTime: 1616828201315,
        },
        {
          clientOrderId: "electron_e6e8df52da8a493c92697dde163",
          cummulativeQuoteQty: "11.81700000",
          executedQty: "9.09000000",
          icebergQty: "0.00000000",
          isWorking: true,
          orderId: 282626952,
          orderListId: -1,
          origQty: "9.09000000",
          origQuoteOrderQty: "0.00000000",
          price: "1.30000000",
          side: "BUY",
          status: "FILLED",
          stopPrice: "0.00000000",
          symbol: "ALGOUSDT",
          time: 1615808146502,
          timeInForce: "GTC",
          type: "LIMIT",
          updateTime: 1615808149177,
        },
        {
          clientOrderId: "electron_e228d0d41b594406a345db4a454",
          cummulativeQuoteQty: "0.00000000",
          executedQty: "0.00000000",
          icebergQty: "0.00000000",
          isWorking: true,
          orderId: 285606885,
          orderListId: -1,
          origQty: "200.00000000",
          origQuoteOrderQty: "0.00000000",
          price: "1.22200000",
          side: "BUY",
          status: "CANCELED",
          stopPrice: "0.00000000",
          symbol: "ALGOUSDT",
          time: 1615905195886,
          timeInForce: "GTC",
          type: "LIMIT",
          updateTime: 1615905595983,
        },
        {
          clientOrderId: "electron_532b4d42dc2c49839f9b12241cc",
          cummulativeQuoteQty: "244.86436000",
          executedQty: "200.38000000",
          icebergQty: "0.00000000",
          isWorking: true,
          orderId: 285634040,
          orderListId: -1,
          origQty: "200.38000000",
          origQuoteOrderQty: "0.00000000",
          price: "1.22200000",
          side: "BUY",
          status: "FILLED",
          stopPrice: "0.00000000",
          symbol: "ALGOUSDT",
          time: 1615906436667,
          timeInForce: "GTC",
          type: "LIMIT",
          updateTime: 1615906600064,
        },
        {
          clientOrderId: "electron_8c372079df8548d58e8b10e27eb",
          cummulativeQuoteQty: "39.01065000",
          executedQty: "35.05000000",
          icebergQty: "0.00000000",
          isWorking: true,
          orderId: 303883013,
          orderListId: -1,
          origQty: "35.05000000",
          origQuoteOrderQty: "0.00000000",
          price: "1.11300000",
          side: "BUY",
          status: "FILLED",
          stopPrice: "0.00000000",
          symbol: "ALGOUSDT",
          time: 1616828349649,
          timeInForce: "GTC",
          type: "LIMIT",
          updateTime: 1616828408503,
        },
        {
          clientOrderId: "electron_6cf16bf4a8ec4c5cb4d49b383c4",
          cummulativeQuoteQty: "0.00000000",
          executedQty: "0.00000000",
          icebergQty: "0.00000000",
          isWorking: true,
          orderId: 315104819,
          orderListId: -1,
          origQty: "29.93000000",
          origQuoteOrderQty: "0.00000000",
          price: "1.24260000",
          side: "BUY",
          status: "CANCELED",
          stopPrice: "0.00000000",
          symbol: "ALGOUSDT",
          time: 1617363630381,
          timeInForce: "GTC",
          type: "LIMIT",
          updateTime: 1617363772259,
        },
        {
          clientOrderId: "electron_a01b7841137f49188f7012ea1da",
          cummulativeQuoteQty: "15.92935000",
          executedQty: "11.95000000",
          icebergQty: "0.00000000",
          isWorking: true,
          orderId: 317286717,
          orderListId: -1,
          origQty: "11.95000000",
          origQuoteOrderQty: "0.00000000",
          price: "1.33300000",
          side: "BUY",
          status: "FILLED",
          stopPrice: "0.00000000",
          symbol: "ALGOUSDT",
          time: 1617471175427,
          timeInForce: "GTC",
          type: "LIMIT",
          updateTime: 1617471181844,
        },
        {
          clientOrderId: "electron_11df65ff684b4344a95dfea3ee0",
          cummulativeQuoteQty: "207.36962700",
          executedQty: "4.63000000",
          icebergQty: "0.00000000",
          isWorking: true,
          orderId: 876024961,
          orderListId: -1,
          origQty: "4.63000000",
          origQuoteOrderQty: "0.00000000",
          price: "44.95580000",
          side: "BUY",
          status: "FILLED",
          stopPrice: "0.00000000",
          symbol: "DOTUSDT",
          time: 1618664038463,
          timeInForce: "GTC",
          type: "LIMIT",
          updateTime: 1618664038463,
        },
        {
          clientOrderId: "electron_f85bb8df0ae7466395233395ffe",
          cummulativeQuoteQty: "0.00000000",
          executedQty: "0.00000000",
          icebergQty: "0.00000000",
          isWorking: true,
          orderId: 184763375,
          orderListId: -1,
          origQty: "1.61000000",
          origQuoteOrderQty: "0.00000000",
          price: "226.00000000",
          side: "BUY",
          status: "CANCELED",
          stopPrice: "0.00000000",
          symbol: "EGLDUSDT",
          time: 1618157589928,
          timeInForce: "GTC",
          type: "LIMIT",
          updateTime: 1618157603680,
        },
        {
          clientOrderId: "electron_e09dbf14b0e04407b6e7486bd42",
          cummulativeQuoteQty: "0.00000000",
          executedQty: "0.00000000",
          icebergQty: "0.00000000",
          isWorking: true,
          orderId: 184764039,
          orderListId: -1,
          origQty: "1.65400000",
          origQuoteOrderQty: "0.00000000",
          price: "220.00000000",
          side: "BUY",
          status: "CANCELED",
          stopPrice: "0.00000000",
          symbol: "EGLDUSDT",
          time: 1618157611171,
          timeInForce: "GTC",
          type: "LIMIT",
          updateTime: 1618157767205,
        },
        {
          clientOrderId: "electron_fbbfd37e588f4538829e0cb0033",
          cummulativeQuoteQty: "0.00000000",
          executedQty: "0.00000000",
          icebergQty: "0.00000000",
          isWorking: true,
          orderId: 184767853,
          orderListId: -1,
          origQty: "1.61700000",
          origQuoteOrderQty: "0.00000000",
          price: "225.00000000",
          side: "BUY",
          status: "CANCELED",
          stopPrice: "0.00000000",
          symbol: "EGLDUSDT",
          time: 1618157776005,
          timeInForce: "GTC",
          type: "LIMIT",
          updateTime: 1618158759569,
        },
        {
          clientOrderId: "electron_aff6cc31b37449058cb7c245729",
          cummulativeQuoteQty: "363.88100000",
          executedQty: "1.58900000",
          icebergQty: "0.00000000",
          isWorking: true,
          orderId: 184786406,
          orderListId: -1,
          origQty: "1.58900000",
          origQuoteOrderQty: "0.00000000",
          price: "229.00000000",
          side: "BUY",
          status: "FILLED",
          stopPrice: "0.00000000",
          symbol: "EGLDUSDT",
          time: 1618158790998,
          timeInForce: "GTC",
          type: "LIMIT",
          updateTime: 1618159251028,
        },
        {
          clientOrderId: "electron_cd355c3df38b477d95547b4f686",
          cummulativeQuoteQty: "0.00000000",
          executedQty: "0.00000000",
          icebergQty: "0.00000000",
          isWorking: true,
          orderId: 149498096,
          orderListId: -1,
          origQty: "109.09000000",
          origQuoteOrderQty: "0.00000000",
          price: "6.80000000",
          side: "BUY",
          status: "CANCELED",
          stopPrice: "0.00000000",
          symbol: "NEARUSDT",
          time: 1615723565454,
          timeInForce: "GTC",
          type: "LIMIT",
          updateTime: 1615723575996,
        },
        {
          clientOrderId: "electron_c358b823ef754c188e2d3710911",
          cummulativeQuoteQty: "741.82500000",
          executedQty: "109.90000000",
          icebergQty: "0.00000000",
          isWorking: true,
          orderId: 149528093,
          orderListId: -1,
          origQty: "109.90000000",
          origQuoteOrderQty: "0.00000000",
          price: "6.75000000",
          side: "BUY",
          status: "FILLED",
          stopPrice: "0.00000000",
          symbol: "NEARUSDT",
          time: 1615726104110,
          timeInForce: "GTC",
          type: "LIMIT",
          updateTime: 1615726144689,
        },
        {
          clientOrderId: "electron_ba544aa292e94963a1b1e25c2a7",
          cummulativeQuoteQty: "0.00000000",
          executedQty: "0.00000000",
          icebergQty: "0.00000000",
          isWorking: true,
          orderId: 168035500,
          orderListId: -1,
          origQty: "109.79000000",
          origQuoteOrderQty: "0.00000000",
          price: "5.50000000",
          side: "SELL",
          status: "CANCELED",
          stopPrice: "0.00000000",
          symbol: "NEARUSDT",
          time: 1616827346873,
          timeInForce: "GTC",
          type: "LIMIT",
          updateTime: 1616828051424,
        },
        {
          clientOrderId: "electron_1ec2e058e5b046e394700736f32",
          cummulativeQuoteQty: "595.06180000",
          executedQty: "109.79000000",
          icebergQty: "0.00000000",
          isWorking: true,
          orderId: 168050353,
          orderListId: -1,
          origQty: "109.79000000",
          origQuoteOrderQty: "0.00000000",
          price: "5.42000000",
          side: "SELL",
          status: "FILLED",
          stopPrice: "0.00000000",
          symbol: "NEARUSDT",
          time: 1616828076980,
          timeInForce: "GTC",
          type: "LIMIT",
          updateTime: 1616828179702,
        },
        {
          clientOrderId: "electron_de9015814cfd4e33a96a786ed5b",
          cummulativeQuoteQty: "0.00117920",
          executedQty: "1.60000000",
          icebergQty: "0.00000000",
          isWorking: true,
          orderId: 395374800,
          orderListId: -1,
          origQty: "1.60000000",
          origQuoteOrderQty: "0.00000000",
          price: "0.00073700",
          side: "BUY",
          status: "FILLED",
          stopPrice: "0.00000000",
          symbol: "DOTBTC",
          time: 1618663509939,
          timeInForce: "GTC",
          type: "LIMIT",
          updateTime: 1618663526289,
        },
        {
          clientOrderId: "electron_de9015814cfd4e33a96a786ed5b",
          cummulativeQuoteQty: "0.00117920",
          executedQty: 0.0011792,
          icebergQty: "0.00000000",
          isWorking: true,
          orderId: 395374800,
          orderListId: -1,
          origQty: "1.60000000",
          origQuoteOrderQty: "0.00000000",
          price: "0.00073700",
          side: "SELL",
          status: "FILLED",
          stopPrice: "0.00000000",
          symbol: "BTCUSDT",
          time: 1618663509940,
          timeInForce: "GTC",
          type: "LIMIT",
          updateTime: 1618663526290,
        },
      ],
      componentKey: 0,
      pieChartData: {
        chart: {
          caption: "Current Portfolio Distribution",
          showValues: "1",
          showPercentInTooltip: "2",
          numberPrefix: "%",
          enableMultiSlicing: "1",
          theme: "fusion",
        },
        data: [],
      },
      timeSeriesSchema: [
        {
          name: "Time",
          type: "date",
          // format: "%a-%d-%b-%Y",
        },
        {
          name: "Coin",
          type: "string",
        },
        {
          name: "Asset Value",
          type: "number",
        },
      ],
      timeSeriesData: {
        data: null,
        caption: {
          text: "Portfolio Net Asset Value",
        },
        subcaption: {
          text: "Over 4 Hourly Data",
        },
        series: "Coin",
        xAxis: { plot: "Time" },
        yAxis: [
          {
            plot: "Asset Value",
            title: "Asset Value",
            format: {
              prefix: "$",
            },
          },
        ],
      },
    };
  },
  components: {
    NavBar,
    Loading,
    BTable,
  },
  methods: {
    computeWeights() {
      axios
        .post(HOSTNAME + "5001/compute_weights", { data: this.assets })
        .then((res) => {
          (this.pieChartData.data = res.data.plotting_data),
            (this.computed_assets = res.data.data);
        });
    },

    computeHistoricalPosition() {
      axios
        .post(HOSTNAME + "5003/compute_historical_positions", {
          data: this.order_history,
        })
        .then((res) => {
          const fusionTable = new FusionCharts.DataStore().createDataTable(
            res.data.data,
            this.timeSeriesSchema
          );
          this.timeSeriesData.data = fusionTable;
          console.log(this.timeSeriesData.data);
        });
    },
  },
  mounted() {
    this.api_secret = this.$store.state.api_details.secret;
    this.api_key = this.$store.state.api_details.key;
    this.assets = this.$store.state.assets;
    this.computeWeights();
    this.computeHistoricalPosition();
  },
};
</script>
